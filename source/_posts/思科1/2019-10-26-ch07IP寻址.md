---
title: 2019-10-26-ch07IP寻址
categories: 思科1
---
# IP编址
categories: 思科1
## IPv4网络地址

### IPv4地址结构

* 包括网络部分和主机部分, 标识网络和主机
* 子网掩码: IP地址和子网掩码做与运算, 如果结果相同, 则表示为在同一个子网下.
* 非标准子网掩码: 用1的个数标识子网掩码: /27标识子网掩码前27位是1, 后面5位是0. 用IP地址+斜杠标识: `192.168.0.250/27`, 长度越大, 子网网段内地址越少. 
* 主机位全为1的地址是广播地址, 全为0是网段地址

### IPv4单播, 组播, 广播

* 特殊用途的地址段
  * 组播地址
    * 224.0.0.0-239.255.255.255: 用于组播
    * 224.0.0.0-224.0.0.255: 用于本地组播
    * 224.0.0.9: 用于RIP通讯
  * 私有地址
    * 10.0.0.0/8
    * 172.16.0.0/12, 即172.16.0.0-172.31.255.255
    * 192.168.0.0/16
  * 特殊地址
    * 127.0.0.0/8, 用于测试IPv4协议栈
    * 169.254.0.0/16, 如果主机ip地址为此, 说明ip地址配置错误/没有dhcp服务器. 这个地址仅能用于内网通讯

* 有类编制, 目前已不采用, 用统一组织分配IP地址. 目前IPv4地址已耗尽
  * A类: 0.0.0.0/8 – 127.0.0.0/8
  * B类128.0.0.0 /16 – 191.255.0.0 /16
  * C类192.0.0.0 /24 – 223.255.255.0 /24

## IPv6网络地址

### IPv4和IPv6共存

* 双堆栈: 同时有IPv4和v6协议栈
* 隧道: 让IPv6协议通过IPv4网络
* 转换: IPv6地址转化为IPv4

### IPv6编址

* 128位2进制编码, 用8组*4位16进制编码, 用冒号分隔.
* 简写方式
  * 每个段由4个16进制构成, 可以忽略开头的0, 如果一个段全为0, 至少写1个0. 
  * 可以使用**一次**双冒号来省略全是0的段落. 
* 前64位是前缀(网络地址), 后64位是接口id(主机地址)

### IPv6地址类型

* 单播: 唯一标记一个支持IPv6的**接口**
* 组播: 把单个IPv6数据包发送到各个目的地
  * 全节点组播地址: 相当于广播
* 任播: 可以分配到多个设备, 任播地址的数据包会送到最近拥有该地址的路由.
* 前缀(网络部分)64位, 接口(主机部分)64位.

### IPv6单播地址

用来唯一标识支持IPv6的设备的接口, 源地址必须是单播地址, 目的地址可以是组播或单播地址.

* 全局单播(GUA): 公共地址, 前16位从2000到3FFF, 第一位是2或3. 前缀48位+16位子网id+最后64位是接口ID. 
* 本地链路: 子网 **FE80::/10** , 在同一个链路(子网)上通信. 全局单播不是必须的, 但是必须要有本地链路地址. 如果没有手动配置, 且没有dhcp, 设备会自动创建本地链路地址. FE80::/10表示范围是`1111 1110 10xx xxxx`, 即从`1111 1110 1000 0000`, 到`1111 1110 1011 1111`
* 唯一本地: FC00::/7-FDFF::/7, 唯一本地地址用于一个站点内或数量有限的站点之间的本地编址
* 环回: ::1/128

### 静态配置

```
en
conf t
inter g0/0
ipv6 addr ...
```

### 动态配置

* SLAAC, 无状态地址自动配置, 无需使用DHCPv6服务器, 根据本地路由器的 ICMPv6 路由器通告 (RA) 消息获取必要信息

  * RA消息

    IPv6 路由器每 200 秒定期将 ICMPv6 RA 消息发送到网络上所有支持 IPv6 的设备. 在响应发送 ICMPv6 路由器请求 (RS) 消息的主机时, 也会发送 RA 消息

  * RA内容

    * 网络前缀与前缀长度
    * RA消息的源IPv6地址作为默认网关的IPv6本地链路地址
    * DNS地址和域名

  * RA选项

    * 仅SLAAC, 

      RA内容包含前缀, 前缀长度, 默认网关

    * SLAAC和无状态DHCPv6

      RA内容包含前缀, 前缀长度, 默认网关, 从DHCP服务器获得域名等其他信息

    * 有状态DHCPv6

      RA只发送默认网关,  全局单播地址, DNS 服务器地址,域名和所有其他信息从DHCP服务器获得

  * 客户端接收到前缀之后使用EUI-64或随机64位作为接口ID

* SLAAC和无状态DHCP
  
* RA选项为SLAAC和无状态DHCPv6
  
* 有状态DHCP
  
  * RA选项为SLAAC和有状态DHCP

### 静态配置

```
ipv6 addr fe80::1 link-local
```

### 检验IPv6配置

```
show ipv6 interface brief
```

### IPv6 组播地址

* 分配的组播: 为预先定义的设备组保留的组播地址. 有两种目的IPv6地址, 为: 
  * FF02::1 全节点组播, 发送到所有支持IPv6的设备组
  * FF02::1 全路由组播组, 路由器会转发组播消息到所有支持IPv6设备

* 请求节点IPv6组播地址
  *  被映射到特殊的以太网组播地址 , 以太网网卡可以过滤帧

## ICMP

### 基本功能

* 主机确认: 确定主机是否正常
* 目标或服务不可达
  * 0-网络不可达
  * 1-主机不可达
  * 2-协议
  * 3-端口
* 超时

### ICMPv6的新功能

* 地址解析: 使用NS(邻居查询)获得周围设备的MAC地址
* 重复地址检测(DAD): 检测是否是唯一的地址(不必须), 即NA(邻居通告)
* 还有请求IPv6地址的RA和RS

## 测试

### Ping, 测试本地协议栈

ping 127.0.0.1

ping ::1 

### Traceroute, 测试路径

提供每一跳的往返时间(让TTL从1开始增大, 测得通过每一个路由器往返时间)

IPv4用TTL限制跳数, IPv6用跳数限制限制跳数