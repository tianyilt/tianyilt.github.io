---
title: 2019-09-28-ch05以太网
categories: 思科1
---
# 以太网
categories: 思科1
思乐公司发明, 最流行的LAN技术. 以太网协议定义了网络通信的很多方面: 

* 帧格式
* 帧大小
* 时序
* 编码

## 以太网协议

### 以太网帧

* 以太网封装

  * 最大支持100Gb/s的带宽, 定义二层协议和一层技术.
  * LLC子层, 获取网络协议数据(IPv4数据包)加入控制信息, 帮助数据包传送到目的节点. 可将其视为网卡的驱动程序. 
  * MAC子层, 由硬件(计算机网卡)实施. 

* MAC子层

  * 职责为:

    * 数据封装
    * 介质访问控制

  * 数据封装: 发送前-组装帧, 收到帧-解析帧. 构建帧时向网络层PDU添加帧头帧尾

    * 帧定界: 标识组成帧的一组位,  这些定界位会对发送节点与接收节点进行同步.
    * 编制:  封装过程包含第 3 层 PDU, 还提供数据链路层编址. 
    * 错误检测: 由帧尾负责

  * 介质访问控制: 把帧放入介质中, 或从介质中移除帧. 控制对介质的访问. 直接与物理层沟通. 

  * 以太网帧结构

    ![1570880643982](2019-09-28-ch5以太网/1570880643982.png)

    ethernet II 是TCP/IP网络中使用的以太网帧格式.

* 以太网帧字段

  * 帧字段构成
    * 前导码: 7个字节+起始帧分界符(SFD)1个字节=8个字节. 通知对方准备接收帧, 并同步发送和接收设备.
    * 目的MAC地址: 6个字节
    * 源MAC地址: 6个字节
    * EtherType: 2个字节, 以太网帧的上层协议(IPv4, IPv6, ARP等)
    * 数据字段, 46-1500个字节, 三层PDU. 
    * FCS: 帧校验序列, 4个字节, 使用冗余循环检验(CRC), 发送帧包含CRC结果, 接收方计算CRC, 两者一致说明没有错误. 
  * 最小64字节, 最大1518字节, 否则被丢弃.

### MAC地址

* 48位, 12个16进制数, 每块网卡都有一个MAC地址. 刻录在网卡的ROM中, 不可更改. 
* 前三个字节是厂商编码: OUI, 组织唯一标识符, 接着三个字节由厂商分配. 思科OUI是00-60-2F
* 单播MAC地址: 单播通讯必须指定对方设备的MAC地址, 只处理符合自己MAC地址的信息. 
* 多播: MAC地址为FF-FF-FF-FF-FF-FF
*  IPv4 组播地址的范围为 224.0.0.0 到 239.255.255.255,  IPv6 组播地址的范围以 FF00::/8 开头.  与 IPv4 组播地址关联的组播 MAC 地址是以 01-00-5E 开头,  其余部分通过将 IP 组播组地址的低 23 位换算成 6 个十六进制字符而创建. IPv6组播地址以33-33开头. 
* 使用短横`-`, 冒号`:`或句点`.`来分割

## 交换机

* 二层设备, 只根据MAC地址做转发. 
* MAC地址表, 可编制内存(CAM)表, 在接受到端口1的信息, 包括源MAC和目标MAC, CAM记录这个端口对应的MAC地址, 然后给除了来源以外的端口群发信息(flood out, 泛洪), 4端口收到信息然后回复, CAM记录4端口对应的MAC地址. 
  * 一个端口可以对应多个MAC地址, 一个MAC地址只能出现在一个端口.

### 交换机转发

* 存储转发: 存储整个帧道缓冲区, CRC校验完毕, 转发
* 直通: 收到数据包立刻转发. 不做错误检查. 
  * 快速转发交换: 读取到MAC立刻转发. 延时指 收到第一个位到传出第一个位之间的时间差 .
  * 免分片交换, 交换机检验数据前64个字节, 没有错误之后, 全部转发.

* 内存缓冲: 转发帧之前存储帧, 当端口拥塞是, 可以一直存储帧到可以传送该帧.
  * 基于端口的内存缓冲, 缓存到传入-传出端口的队列中, 只有前面的帧都成功传送之后才会传送. 
  *  共享内存缓冲, 一个公共的缓冲区,  这可以使更多带宽专用于特定端口, 例如连接到服务器的端口. 
* 双工和速度设置:  交换机端口和连接的设备的双工设置和带宽设置必须匹配. 自动协调功能会自动选择高性能模式
* Auto-MDIX: 自动介质相关接口交叉, 不用分别直通或者交叉电缆. 默认启用.

## 地址解析协议

### MAC和IP

* MAC地址, 物理地址. 以太网网卡的通信
* IP地址, 逻辑地址.

* 前往远程网络:
  * 目的MAC地址位默认网关的地址
  * 路由器收到帧, 根据IPv4的地址, 确定转发路径
  * 负责转发的路由器收到帧, 根据IP地址确定下一跳的设备, 目的MAC地址修改为下一跳的MAC地址.

### ARP

* IP和MAC的映射
* ARP请求包括目标IP, 源MAC. 使用`arp -a`(windows)来查看MAC地址表. 两分钟没有使用的MAC地址会被删掉. 静态MAC地址是有特殊用途的, 不会被删除. 

* 如果数据包的目的 IPv4 地址与源 IPv4 地址处于同一个网络, 则设备会在 ARP 表中搜索目的 IPv4 地址.

- 如果目的 IPv4 地址与源 IPv4 地址不在同一个网络中, 则设备会在 ARP 表中搜索默认网关的 IPv4 地址.
- ARP表的每一行绑定一个IPv4和MAC地址, 如果没有映射, 就发出ARP请求.
- 